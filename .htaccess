# Turn on Rewrite Engine
RewriteEngine On

# Serve dynamic sitemap
RewriteRule ^sitemap\.xml$ /sitemap.php [L]

# Step 1: Redirect any .php URLs to remove extension (e.g., /page.php -> /page)
RewriteCond %{THE_REQUEST} \s/+([^?\s]*?)\.php[\s?] [NC]
RewriteRule ^ /%1? [R=301,L]

# Step 1b: Journal friendly URLs
RewriteRule ^journal$ /journal.php [QSA,L]
RewriteRule ^journal/([A-Za-z0-9-]+)$ /journal.php?slug=$1 [QSA,L]

# Step 2: Redirect URLs with trailing slashes to remove slash (e.g., /page/ -> /page)
# EXCEPT for root directory
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Step 3: Legacy redirects
RewriteRule ^strategy$ /product-strategy [R=301,L]
RewriteRule ^skills$ /hire-me [R=301,L]
RewriteRule ^product-team-vibe-coding$ /product-team-AI-vibe-coding [R=301,L]

# Step 4: Internal rewrite - serve .php files without extension showing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# Step 5: Handle 404 errors - redirect to custom 404 page
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php !-f
RewriteRule ^(.*)$ /404.php [L]