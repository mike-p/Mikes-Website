# Turn on Rewrite Engine
RewriteEngine On

# ============================================
# Caching Headers for Static Assets
# ============================================

# Images: Cache for 1 year (with revalidation)
<FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Expires "Thu, 31 Dec 2025 23:59:59 GMT"
</FilesMatch>

# CSS: No cache (for easy tweaking during development)
<FilesMatch "\.css$">
    Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>

# JavaScript: Cache for 1 year (with revalidation)
<FilesMatch "\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Expires "Thu, 31 Dec 2025 23:59:59 GMT"
</FilesMatch>

# Fonts: Cache for 1 year
<FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Expires "Thu, 31 Dec 2025 23:59:59 GMT"
</FilesMatch>


# ============================================
# URL Rewriting Rules
# ============================================

# Redirect www to non-www (canonical domain)
RewriteCond %{HTTP_HOST} ^www\.mike-p\.co\.uk$ [NC]
RewriteRule ^(.*)$ https://mike-p.co.uk/$1 [R=301,L]

# Serve dynamic sitemap
RewriteRule ^sitemap\.xml$ /sitemap.php [L]

# Step 1: Redirect any .php URLs to remove extension (e.g., /page.php -> /page)
RewriteCond %{THE_REQUEST} \s/+([^?\s]*?)\.php[\s?] [NC]
RewriteRule ^ /%1? [R=301,L]

# Step 1b: Journal friendly URLs
RewriteRule ^journal$ /journal.php [QSA,L]
RewriteRule ^journal/([A-Za-z0-9-]+)$ /journal.php?slug=$1 [QSA,L]

# Step 2: Redirect URLs with trailing slashes to remove slash (e.g., /page/ -> /page)
# EXCEPT for root directory
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Step 3: Legacy redirects
RewriteRule ^strategy$ /product-strategy [R=301,L]
RewriteRule ^skills$ /hire-me [R=301,L]
RewriteRule ^contact$ /hire-me [R=301,L]
RewriteRule ^about$ /hire-me [R=301,L]
RewriteRule ^product-team-vibe-coding$ /product-team-AI-vibe-coding [R=301,L]
RewriteRule ^interests$ /journal [R=301,L]

# Step 4: Internal rewrite - serve .php files without extension showing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# Step 5: Handle 404 errors - redirect to custom 404 page
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php !-f
RewriteRule ^(.*)$ /404.php [L]